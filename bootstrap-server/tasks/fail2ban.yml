- name: Install fail2ban
  ansible.builtin.apt:
    name: fail2ban
    state: present
    update_cache: yes

- name: Create jail.local
  ansible.builtin.copy:
    dest: /etc/fail2ban/jail.local
    mode: "0644"
    content: |
      [DEFAULT]
      bantime = {{ fail2ban_bantime }}
      findtime = {{ fail2ban_findtime }}
      maxretry = {{ fail2ban_maxretry }}

      [sshd]
      enabled = true
      port = {{ ssh_port }}
      logpath = %(sshd_log)s
      backend = systemd

- name: Enable and start fail2ban
  ansible.builtin.service:
    name: fail2ban
    state: restarted
    enabled: yes
